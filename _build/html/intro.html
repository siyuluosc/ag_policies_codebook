
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Codebook for Web-scraping of State Legislative Info</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=1a96265c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=60c0e2ec"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'intro';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
  
    <p class="title logo__title">None</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    Codebook for Web-scraping of State Legislative Info
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">









</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/yanxulong/UCSC-UMN-AFRI-project/tree/main/Codebook/_build/html" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/yanxulong/UCSC-UMN-AFRI-project/tree/main/Codebook/_build/html/issues/new?title=Issue%20on%20page%20%2Fintro.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Codebook for Web-scraping of State Legislative Info</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-Cover">Codebook for State-Level Policies Affecting Agricultural Costs and Revenues in the U.S.: a comprehensive database (1975-2021), patterns, and analysis of policy correlates</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch1">Chapter 1 Introduction</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch2">Chapter 2 Web-scraping tool setup</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch3">Chapter 3 Data cleaning</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch4">Chapter 4 Topic Classification</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="intro.html#topic-classification">4.2 Topic Classification</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch5">Chapter 5 Sentiment analysis</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch6">Chapter 6 Conclusion</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch7">Chapter 7 Appendix</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="codebook-for-web-scraping-of-state-legislative-info">
<h1>Codebook for Web-scraping of State Legislative Info<a class="headerlink" href="#codebook-for-web-scraping-of-state-legislative-info" title="Link to this heading">#</a></h1>
<p>Web scraping is an interactive process between computers and websites using HyperText Markup Language (HTML). Through HTML, web scraping can use bots to extract content and data from websites. Several softwares, like Python, R, and STATA can be used to do web scraping. Here legislative information web scraping is achieved by Python.</p>
<p>In this codebook, special Python language terms like Python module, library, function,and syntax are all italic and texts in the box represent code. Full codes without interpretation are in the appendix.</p>
<div class="toctree-wrapper compound">
<span id="document-Cover"></span><section class="tex2jax_ignore mathjax_ignore" id="codebook-for-state-level-policies-affecting-agricultural-costs-and-revenues-in-the-u-s-a-comprehensive-database-1975-2021-patterns-and-analysis-of-policy-correlates">
<h2>Codebook for State-Level Policies Affecting Agricultural Costs and Revenues in the U.S.: a comprehensive database (1975-2021), patterns, and analysis of policy correlates<a class="headerlink" href="#codebook-for-state-level-policies-affecting-agricultural-costs-and-revenues-in-the-u-s-a-comprehensive-database-1975-2021-patterns-and-analysis-of-policy-correlates" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">![](</span>pics/booklogo.png<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>zsh:1: unknown file attribute: i
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-ch1"></span><section class="tex2jax_ignore mathjax_ignore" id="chapter-1-introduction">
<h2>Chapter 1 Introduction<a class="headerlink" href="#chapter-1-introduction" title="Link to this heading">#</a></h2>
<p>We assemble and make public a novel database of all state-level legislation affecting the costs and revenues associated with agriculture in the United States for the period 1975 to 2021, no matter whether the objectives of those policies were directly related to agriculture or not. Using a combination of web-scraping, machine-learning methods, and artificial intelligence, we (i) analyze all state-level legislation the study 1975-2021 to identify any policies that are likely to affect agricultural costs and revenues, either directly or indirectly, (ii) develop a mechanism to classify whether and how each policy increases or decreases those same agricultural costs and revenues for specific commodities and crops within each state, and (iii) create a web-based tool to allow other researchers to search and browse collected policies by commodity or crop. We will use these data to answer three specific research questions. First, what are the broad patterns over time when it comes to agricultural policy in the U.S. Second, what are the geographical patterns? Third, we will analyze the correlates of agricultural policy within each state for the study period. Finally, we will write a codebook to allow researchers interested in using these data for their own research purposes, and we will make the codebook, data, and web-based tool publicly available through the websites of our respective institutions.</p>
</section>
<span id="document-ch2"></span><section class="tex2jax_ignore mathjax_ignore" id="chapter-2-web-scraping-tool-setup">
<h2>Chapter 2 Web-scraping tool setup<a class="headerlink" href="#chapter-2-web-scraping-tool-setup" title="Link to this heading">#</a></h2>
<p>In this chapter, we introduce the webscraping tool set.</p>
<section id="python-language">
<h3>Python Language<a class="headerlink" href="#python-language" title="Link to this heading">#</a></h3>
<p>Python is a programming language that lets you work more quickly and integrate your systems more effectively (<a class="reference external" href="https://www.python.org/">https://www.python.org/</a>).</p>
</section>
<section id="ides">
<h3>IDEs<a class="headerlink" href="#ides" title="Link to this heading">#</a></h3>
<p>An IDE (Integrated Development Environment) understand your code much better than a text editor. It usually provides features such as build automation, code linting, testing and debugging. This can significantly speed up your work. The downside is that IDEs can be complicated to use. There are several IDEs that users can consider. Here we recommend PyCharm or Visual Studio Code. You can download them from JetBrains’ website <a class="reference external" href="https://www.jetbrains.com/pycharm/">https://www.jetbrains.com/pycharm/</a> or Visual Studio Code’ websites <a class="reference external" href="https://code.visualstudio.com/">https://code.visualstudio.com/</a>.</p>
</section>
<section id="libraries">
<h3>Libraries<a class="headerlink" href="#libraries" title="Link to this heading">#</a></h3>
<p>A Python library, like packages in R, is a reusable chunk of code to save time. Several useful libraries are needed to install for Python to run this script.</p>
<p>Selenium is a powerful web scraping tool by automating browsers to load the target website, retrieve the required data, and take screenshots or assert that certain actions happen on the website. This script relies heavily on Selenium. In addition to Selenium, we also need to import other necessary packages such as pandas,time, os, PyPDF2, glob, pick</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import libraries</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support.ui</span> <span class="kn">import</span> <span class="n">WebDriverWait</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support</span> <span class="kn">import</span> <span class="n">expected_conditions</span> <span class="k">as</span> <span class="n">EC</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support.ui</span> <span class="kn">import</span> <span class="n">Select</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datefinder</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">PyPDF2</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">fitz</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># import libraries</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">selenium.webdriver.support.ui</span> <span class="kn">import</span> <span class="n">WebDriverWait</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;selenium&#39;
</pre></div>
</div>
</div>
</div>
<p>Our goal is to webscrape all session laws during 1975-2022 from state-level legislature websites. The General and Special Laws of Texas, often referred to as the “session laws,” constitute a complete set of all bills passed into law by each session of the state legislature.Session laws are organized into chapters, with each chapter consisting of a single “Act,” or bill. As bills are passed into law during a legislative session, the Secretary of State assigns each Act a corresponding chapter number.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>FIPS State Numeric Code</p></th>
<th class="head text-right"><p>Official USPS Code</p></th>
<th class="head text-right"><p>Website Address</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Alabama</p></td>
<td><p>1</p></td>
<td class="text-right"><p>AL</p></td>
<td class="text-right"><p><a class="reference external" href="https://arc-sos.state.al.us/CGI/actyear.mbr/input">https://arc-sos.state.al.us/CGI/actyear.mbr/input</a></p></td>
</tr>
<tr class="row-odd"><td><p>Alaska</p></td>
<td><p>2</p></td>
<td class="text-right"><p>AK</p></td>
<td class="text-right"><p><a class="reference external" href="http://www.akleg.gov/basis/Home/BillsandLaws">http://www.akleg.gov/basis/Home/BillsandLaws</a></p></td>
</tr>
<tr class="row-even"><td><p>Arizona</p></td>
<td><p>4</p></td>
<td class="text-right"><p>AZ</p></td>
<td class="text-right"><p><a class="reference external" href="https://apps.azleg.gov/BillStatus/BillOverview?Sessionid=123">https://apps.azleg.gov/BillStatus/BillOverview?Sessionid=123</a></p></td>
</tr>
<tr class="row-odd"><td><p>Arkansas</p></td>
<td><p>5</p></td>
<td class="text-right"><p>AR</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.arkleg.state.ar.us/Acts/">https://www.arkleg.state.ar.us/Acts/</a></p></td>
</tr>
<tr class="row-even"><td><p>California</p></td>
<td><p>6</p></td>
<td class="text-right"><p>CA</p></td>
<td class="text-right"><p><a class="reference external" href="https://leginfo.legislature.ca.gov/faces/home.xhtml">https://leginfo.legislature.ca.gov/faces/home.xhtml</a></p></td>
</tr>
<tr class="row-odd"><td><p>Colorado</p></td>
<td><p>8</p></td>
<td class="text-right"><p>CO</p></td>
<td class="text-right"><p><a class="reference external" href="https://leg.colorado.gov/bills">https://leg.colorado.gov/bills</a></p></td>
</tr>
<tr class="row-even"><td><p>Connecticut</p></td>
<td><p>9</p></td>
<td class="text-right"><p>CT</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.cga.ct.gov/asp/menu/legdownload.asp">https://www.cga.ct.gov/asp/menu/legdownload.asp</a></p></td>
</tr>
<tr class="row-odd"><td><p>Delaware</p></td>
<td><p>10</p></td>
<td class="text-right"><p>DE</p></td>
<td class="text-right"><p><a class="reference external" href="https://legis.delaware.gov/AllLegislation">https://legis.delaware.gov/AllLegislation</a></p></td>
</tr>
<tr class="row-even"><td><p>District of Columbia</p></td>
<td><p>11</p></td>
<td class="text-right"><p>DC</p></td>
<td class="text-right"><p><a class="reference external" href="https://lims.dccouncil.us/searchresult/">https://lims.dccouncil.us/searchresult/</a></p></td>
</tr>
<tr class="row-odd"><td><p>Florida</p></td>
<td><p>12</p></td>
<td class="text-right"><p>FL</p></td>
<td class="text-right"><p><a class="reference external" href="http://www.leg.state.fl.us/Welcome/index.cfm">http://www.leg.state.fl.us/Welcome/index.cfm</a></p></td>
</tr>
<tr class="row-even"><td><p>Georgia</p></td>
<td><p>13</p></td>
<td class="text-right"><p>GA</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.legis.ga.gov/legislation/all">https://www.legis.ga.gov/legislation/all</a></p></td>
</tr>
<tr class="row-odd"><td><p>Hawaii</p></td>
<td><p>15</p></td>
<td class="text-right"><p>HI</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.capitol.hawaii.gov/">https://www.capitol.hawaii.gov/</a></p></td>
</tr>
<tr class="row-even"><td><p>Idaho</p></td>
<td><p>16</p></td>
<td class="text-right"><p>ID</p></td>
<td class="text-right"><p><a class="reference external" href="https://legislature.idaho.gov/statutesrules/sessionlaws/">https://legislature.idaho.gov/statutesrules/sessionlaws/</a></p></td>
</tr>
<tr class="row-odd"><td><p>Illinois</p></td>
<td><p>17</p></td>
<td class="text-right"><p>IL</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.ilga.gov/previousga.asp">https://www.ilga.gov/previousga.asp</a></p></td>
</tr>
<tr class="row-even"><td><p>Indiana</p></td>
<td><p>18</p></td>
<td class="text-right"><p>IN</p></td>
<td class="text-right"><p><a class="reference external" href="http://iga.in.gov/results/#">http://iga.in.gov/results/#</a></p></td>
</tr>
<tr class="row-odd"><td><p>Iowa</p></td>
<td><p>19</p></td>
<td class="text-right"><p>IA</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.legis.iowa.gov/legislation/billTracking">https://www.legis.iowa.gov/legislation/billTracking</a></p></td>
</tr>
<tr class="row-even"><td><p>Kansas</p></td>
<td><p>20</p></td>
<td class="text-right"><p>KS</p></td>
<td class="text-right"><p><a class="reference external" href="http://www.kslegislature.org/li/historical/">http://www.kslegislature.org/li/historical/</a></p></td>
</tr>
<tr class="row-odd"><td><p>Kentucky</p></td>
<td><p>21</p></td>
<td class="text-right"><p>KY</p></td>
<td class="text-right"><p><a class="reference external" href="https://legislature.ky.gov/Law/Pages/KyActs.aspx">https://legislature.ky.gov/Law/Pages/KyActs.aspx</a></p></td>
</tr>
<tr class="row-even"><td><p>Louisiana</p></td>
<td><p>22</p></td>
<td class="text-right"><p>LA</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.legis.la.gov/Legis/SessionInfo/SessionInfo.aspx">https://www.legis.la.gov/Legis/SessionInfo/SessionInfo.aspx</a></p></td>
</tr>
<tr class="row-odd"><td><p>Maine</p></td>
<td><p>23</p></td>
<td class="text-right"><p>ME</p></td>
<td class="text-right"><p><a class="reference external" href="https://legislature.maine.gov/ros/LOM/LOMpdfDirectory.htm">https://legislature.maine.gov/ros/LOM/LOMpdfDirectory.htm</a></p></td>
</tr>
<tr class="row-even"><td><p>Maryland</p></td>
<td><p>24</p></td>
<td class="text-right"><p>MD</p></td>
<td class="text-right"><p><a class="reference external" href="http://mgaleg.maryland.gov/mgawebsite/Search/FullText">http://mgaleg.maryland.gov/mgawebsite/Search/FullText</a></p></td>
</tr>
<tr class="row-odd"><td><p>Massachusetts</p></td>
<td><p>25</p></td>
<td class="text-right"><p>MA</p></td>
<td class="text-right"><p><a class="reference external" href="https://malegislature.gov/Laws/SessionLaws">https://malegislature.gov/Laws/SessionLaws</a></p></td>
</tr>
<tr class="row-even"><td><p>Michigan</p></td>
<td><p>26</p></td>
<td class="text-right"><p>MI</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.legislature.mi.gov/">https://www.legislature.mi.gov/</a></p></td>
</tr>
<tr class="row-odd"><td><p>Minnesota</p></td>
<td><p>27</p></td>
<td class="text-right"><p>MN</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.revisor.mn.gov/search/?search=stat">https://www.revisor.mn.gov/search/?search=stat</a></p></td>
</tr>
<tr class="row-even"><td><p>Mississippi</p></td>
<td><p>28</p></td>
<td class="text-right"><p>MS</p></td>
<td class="text-right"><p><a class="reference external" href="http://billstatus.ls.state.ms.us/sessions.htm">http://billstatus.ls.state.ms.us/sessions.htm</a></p></td>
</tr>
<tr class="row-odd"><td><p>Missouri</p></td>
<td><p>29</p></td>
<td class="text-right"><p>MO</p></td>
<td class="text-right"><p><a class="reference external" href="https://house.mo.gov/LegislationSP.aspx?focusedID=Bill%20List">https://house.mo.gov/LegislationSP.aspx?focusedID=Bill List</a></p></td>
</tr>
<tr class="row-even"><td><p>Montana</p></td>
<td><p>30</p></td>
<td class="text-right"><p>MT</p></td>
<td class="text-right"><p><a class="reference external" href="http://laws.leg.mt.gov/legprd/law0203w$.startup?P_SESS=19991">http://laws.leg.mt.gov/legprd/law0203w$.startup?P_SESS=19991</a></p></td>
</tr>
<tr class="row-odd"><td><p>Nebraska</p></td>
<td><p>31</p></td>
<td class="text-right"><p>NE</p></td>
<td class="text-right"><p><a class="reference external" href="https://nebraskalegislature.gov/laws/laws.php">https://nebraskalegislature.gov/laws/laws.php</a></p></td>
</tr>
<tr class="row-even"><td><p>Nevada</p></td>
<td><p>32</p></td>
<td class="text-right"><p>NV</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.leg.state.nv.us/Site/Search/search.cfm">https://www.leg.state.nv.us/Site/Search/search.cfm</a></p></td>
</tr>
<tr class="row-odd"><td><p>New Hampshire</p></td>
<td><p>33</p></td>
<td class="text-right"><p>NH</p></td>
<td class="text-right"><p><a class="reference external" href="http://www.gencourt.state.nh.us/bill_status/legacy/bs2016/">http://www.gencourt.state.nh.us/bill_status/legacy/bs2016/</a></p></td>
</tr>
<tr class="row-even"><td><p>New Jersey</p></td>
<td><p>34</p></td>
<td class="text-right"><p>NJ</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.njleg.state.nj.us/bills/Bills_ADVS.aspx#">https://www.njleg.state.nj.us/bills/Bills_ADVS.aspx#</a></p></td>
</tr>
<tr class="row-odd"><td><p>New Mexico</p></td>
<td><p>35</p></td>
<td class="text-right"><p>NM</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.nmlegis.gov/Search">https://www.nmlegis.gov/Search</a></p></td>
</tr>
<tr class="row-even"><td><p>New York</p></td>
<td><p>36</p></td>
<td class="text-right"><p>NY</p></td>
<td class="text-right"><p><a class="reference external" href="https://nyassembly.gov/leg/?sh=advanced">https://nyassembly.gov/leg/?sh=advanced</a></p></td>
</tr>
<tr class="row-odd"><td><p>North Carolina</p></td>
<td><p>37</p></td>
<td class="text-right"><p>NC</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.ncleg.gov/Search/BillText/">https://www.ncleg.gov/Search/BillText/</a></p></td>
</tr>
<tr class="row-even"><td><p>North Dakota</p></td>
<td><p>38</p></td>
<td class="text-right"><p>ND</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.legis.nd.gov/search">https://www.legis.nd.gov/search</a></p></td>
</tr>
<tr class="row-odd"><td><p>Ohio</p></td>
<td><p>39</p></td>
<td class="text-right"><p>OH</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.legislature.ohio.gov/legislation/search/">https://www.legislature.ohio.gov/legislation/search/</a></p></td>
</tr>
<tr class="row-even"><td><p>Oklahoma</p></td>
<td><p>40</p></td>
<td class="text-right"><p>OK</p></td>
<td class="text-right"><p><a class="reference external" href="http://www.oklegislature.gov/AdvancedSearchForm.aspx">http://www.oklegislature.gov/AdvancedSearchForm.aspx</a></p></td>
</tr>
<tr class="row-odd"><td><p>Oregon</p></td>
<td><p>41</p></td>
<td class="text-right"><p>OR</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.oregonlegislature.gov/bills_laws/Pages/Oregon-Laws.aspx">https://www.oregonlegislature.gov/bills_laws/Pages/Oregon-Laws.aspx</a></p></td>
</tr>
<tr class="row-even"><td><p>Pennsylvania</p></td>
<td><p>42</p></td>
<td class="text-right"><p>PA</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.legis.state.pa.us/cfdocs/legis/home/bills/">https://www.legis.state.pa.us/cfdocs/legis/home/bills/</a></p></td>
</tr>
<tr class="row-odd"><td><p>Rhode Island</p></td>
<td><p>44</p></td>
<td class="text-right"><p>RI</p></td>
<td class="text-right"><p><a class="reference external" href="http://webserver.rilegislature.gov/search/">http://webserver.rilegislature.gov/search/</a></p></td>
</tr>
<tr class="row-even"><td><p>South Carolina</p></td>
<td><p>45</p></td>
<td class="text-right"><p>SC</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.scstatehouse.gov/query.php">https://www.scstatehouse.gov/query.php</a></p></td>
</tr>
<tr class="row-odd"><td><p>South Dakota</p></td>
<td><p>46</p></td>
<td class="text-right"><p>SD</p></td>
<td class="text-right"><p><a class="reference external" href="https://sdlegislature.gov/Statutes/Archived">https://sdlegislature.gov/Statutes/Archived</a></p></td>
</tr>
<tr class="row-even"><td><p>Tennessee</p></td>
<td><p>47</p></td>
<td class="text-right"><p>TN</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.capitol.tn.gov/legislation/archives.html">https://www.capitol.tn.gov/legislation/archives.html</a></p></td>
</tr>
<tr class="row-odd"><td><p>Texas</p></td>
<td><p>48</p></td>
<td class="text-right"><p>TX</p></td>
<td class="text-right"><p><a class="reference external" href="https://lrl.texas.gov/legis/billsearch/lrlhome.cfm">https://lrl.texas.gov/legis/billsearch/lrlhome.cfm</a></p></td>
</tr>
<tr class="row-even"><td><p>Utah</p></td>
<td><p>49</p></td>
<td class="text-right"><p>UT</p></td>
<td class="text-right"><p><a class="reference external" href="https://le.utah.gov/asp/passedbills/passedbills.asp">https://le.utah.gov/asp/passedbills/passedbills.asp</a></p></td>
</tr>
<tr class="row-odd"><td><p>Vermont</p></td>
<td><p>50</p></td>
<td class="text-right"><p>VT</p></td>
<td class="text-right"><p><a class="reference external" href="https://legislature.vermont.gov/bill/search/2022">https://legislature.vermont.gov/bill/search/2022</a></p></td>
</tr>
<tr class="row-even"><td><p>Virginia</p></td>
<td><p>51</p></td>
<td class="text-right"><p>VA</p></td>
<td class="text-right"><p><a class="reference external" href="https://lis.virginia.gov/cgi-bin/legp604.exe?941+men+BIL">https://lis.virginia.gov/cgi-bin/legp604.exe?941+men+BIL</a></p></td>
</tr>
<tr class="row-odd"><td><p>Washington</p></td>
<td><p>53</p></td>
<td class="text-right"><p>WA</p></td>
<td class="text-right"><p><a class="reference external" href="http://search.leg.wa.gov/search.aspx#document">http://search.leg.wa.gov/search.aspx#document</a></p></td>
</tr>
<tr class="row-even"><td><p>West Virginia</p></td>
<td><p>54</p></td>
<td class="text-right"><p>WV</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.wvlegislature.gov/Bill_Status/bill_status.cfm">https://www.wvlegislature.gov/Bill_Status/bill_status.cfm</a></p></td>
</tr>
<tr class="row-odd"><td><p>Wisconsin</p></td>
<td><p>55</p></td>
<td class="text-right"><p>WI</p></td>
<td class="text-right"><p><a class="reference external" href="https://docs.legis.wisconsin.gov/search">https://docs.legis.wisconsin.gov/search</a></p></td>
</tr>
<tr class="row-even"><td><p>Wyoming</p></td>
<td><p>56</p></td>
<td class="text-right"><p>WY</p></td>
<td class="text-right"><p><a class="reference external" href="https://www.wyoleg.gov/Legislation/archives">https://www.wyoleg.gov/Legislation/archives</a></p></td>
</tr>
<tr class="row-odd"><td><p>Since each state-level legislature website has different website structure, we adopted three different webscraping strategies: (i) direct webscraping, (ii) downloading act PDF files and extraction, and (iii) mixing them.</p></td>
<td><p></p></td>
<td class="text-right"><p></p></td>
<td class="text-right"><p></p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="direct-webscraping">
<h3>Direct Webscraping<a class="headerlink" href="#direct-webscraping" title="Link to this heading">#</a></h3>
<p>Some legislature websites store acts on their websites as html files or PDF files. So, we can webscrape acts’ full texts directly.</p>
<p><img alt="" src="_images/ca.png" /></p>
</section>
</section>
<span id="document-ch3"></span><section class="tex2jax_ignore mathjax_ignore" id="chapter-3-data-cleaning">
<h2>Chapter 3 Data cleaning<a class="headerlink" href="#chapter-3-data-cleaning" title="Link to this heading">#</a></h2>
</section>
<span id="document-ch4"></span><section class="tex2jax_ignore mathjax_ignore" id="chapter-4-topic-classification">
<h2>Chapter 4 Topic Classification<a class="headerlink" href="#chapter-4-topic-classification" title="Link to this heading">#</a></h2>
<section id="chapter-4-1-keywords-generation">
<h3>Chapter 4.1 Keywords Generation<a class="headerlink" href="#chapter-4-1-keywords-generation" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#####################################################################################</span>
<span class="c1">##############################   select gtm_py11 env   ##############################</span>
<span class="c1">#####################################################################################</span>
<span class="c1">#import libraries</span>
<span class="c1"># Check the Python version</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">version</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">working_directory</span> <span class="o">=</span> <span class="s1">&#39;../Guided-Topic-Modeling&#39;</span>
<span class="n">working_directory</span> <span class="o">=</span> <span class="s1">&#39;/Users/long/Library/CloudStorage/OneDrive-Personal/Projects/Guided-Topic-Modeling&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">working_directory</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">bertopic</span> <span class="kn">import</span> <span class="n">BERTopic</span>
<span class="c1">#from sklearn.datasets import fetch_20newsgroups</span>
<span class="kn">import</span> <span class="nn">gensim</span>
<span class="kn">import</span> <span class="nn">gensim.corpora</span> <span class="k">as</span> <span class="nn">corpora</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">from</span> <span class="nn">nltk</span> <span class="kn">import</span> <span class="n">bigrams</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">word_tokenize</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">openpyxl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;punkt&#39;</span><span class="p">)</span>

<span class="c1"># set up working directory</span>
<span class="c1"># Change the working directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>
<span class="c1"># Get the current working directory</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="c1"># Print the current working directory</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current working directory: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cwd</span><span class="p">))</span>

<span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;gtm.py&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--ps1&#39;</span><span class="p">,</span> <span class="s1">&#39;agriculture&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--ps2&#39;</span><span class="p">,</span> <span class="s1">&#39;farm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--pw1&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--pw2&#39;</span><span class="p">,</span> <span class="s1">&#39;0.000000000000000000000000001&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--size&#39;</span><span class="p">,</span> <span class="s1">&#39;1000&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--gravity&#39;</span><span class="p">,</span> <span class="s1">&#39;0.1&#39;</span>
    <span class="c1"># Add &#39;--ns1&#39;, &#39;--ns2&#39;, &#39;--nw1&#39;, &#39;--nw2&#39; and their values if needed</span>
<span class="p">]</span>

<span class="n">exec</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gtm.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;gtm.py&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--ps1&#39;</span><span class="p">,</span> <span class="s1">&#39;agriculture&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--ps2&#39;</span><span class="p">,</span> <span class="s1">&#39;farm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--pw1&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--pw2&#39;</span><span class="p">,</span> <span class="s1">&#39;0.000000000000000000000000001&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--size&#39;</span><span class="p">,</span> <span class="s1">&#39;2000&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--gravity&#39;</span><span class="p">,</span> <span class="s1">&#39;0.1&#39;</span>
    <span class="c1"># Add &#39;--ns1&#39;, &#39;--ns2&#39;, &#39;--nw1&#39;, &#39;--nw2&#39; and their values if needed</span>
<span class="p">]</span>

<span class="n">exec</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gtm.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># Extracting values from sys.argv</span>
<span class="n">ps1_index</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;--ps1&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">size_index</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;--size&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">gravity_index</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;--gravity&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">ps1_value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">ps1_index</span><span class="p">]</span>
<span class="n">size_value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">size_index</span><span class="p">]</span>
<span class="n">gravity_value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">gravity_index</span><span class="p">]</span>

<span class="c1"># Specify the folder path</span>
<span class="n">folder_path</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span>  <span class="c1"># Replace with the actual folder path</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">folder_path</span><span class="p">))</span>

<span class="c1"># Find the last CSV file</span>
<span class="n">csv_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s1">&#39;*.csv&#39;</span><span class="p">))</span>
<span class="n">latest_csv_file</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">csv_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">)</span>

<span class="c1"># Construct new file name</span>
<span class="n">new_file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ps1_value</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">size_value</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">gravity_value</span><span class="si">}</span><span class="s2">.csv&quot;</span>
<span class="n">new_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">new_file_name</span><span class="p">)</span>

<span class="c1"># Rename the file</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">latest_csv_file</span><span class="p">,</span> <span class="n">new_file_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">latest_csv_file</span><span class="si">}</span><span class="s2">&#39; has been renamed to &#39;</span><span class="si">{</span><span class="n">new_file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

<span class="c1"># Read the CSV file (if needed)</span>
<span class="n">topics_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">new_file_path</span><span class="p">)</span>
<span class="n">topics_dict</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">:</span> <span class="s1">&#39;keyword&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">folder_path_ssd</span> <span class="o">=</span> <span class="s1">&#39;/Volumes/SSD/AFRI/Data/Meachine Learning/gtm&#39;</span>
<span class="n">new_file_path_ssd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path_ssd</span><span class="p">,</span> <span class="n">new_file_name</span><span class="p">)</span>
<span class="c1"># Read the CSV file (if needed)</span>
<span class="n">topics_dict</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">new_file_path_ssd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">latest_csv_file</span><span class="si">}</span><span class="s2">&#39; has been renamed to &#39;</span><span class="si">{</span><span class="n">new_file_path_ssd</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">working_directory</span> <span class="o">=</span> <span class="s1">&#39;../Guided-Topic-Modeling&#39;</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">working_directory</span> <span class="o">=</span> <span class="s1">&#39;/Users/long/Library/CloudStorage/OneDrive-Personal/Projects/Guided-Topic-Modeling&#39;</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;pandas&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="topic-classification">
<h2>4.2 Topic Classification<a class="headerlink" href="#topic-classification" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">word_tokenize</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">from</span> <span class="nn">nltk.util</span> <span class="kn">import</span> <span class="n">bigrams</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">ast</span>  <span class="c1"># Module for literal string evaluation</span>

<span class="c1">#from word_forms.word_forms import get_word_forms</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="c1">###</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FuncFormatter</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">import</span> <span class="nn">missingno</span> <span class="k">as</span> <span class="nn">msno</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">wget</span>
<span class="kn">import</span> <span class="nn">openpyxl</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">wordcloud</span> <span class="kn">import</span> <span class="n">WordCloud</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">###</span>

<span class="c1"># Set the working directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/Volumes/SSD/AFRI/Data/&#39;</span><span class="p">)</span>

<span class="c1"># Verify the current working directory</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>


<span class="c1">######## functions</span>

<span class="k">def</span> <span class="nf">generate_uni_bigrams_individual</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="c1"># Convert non-string inputs to strings</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># Try decoding the text using ISO-8859-1 encoding</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># Skip if the text is already a string</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c1"># If decoding with ISO-8859-1 fails, try UTF-8 with errors=&#39;replace&#39;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

    <span class="c1"># Tokenize the text</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">word_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># Remove non-alphabetic tokens and lowercase the alphabetic tokens</span>
    <span class="n">unigrams</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()]</span>

    <span class="c1"># Generate bigrams from the cleaned tokens</span>
    <span class="n">bigram_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bigrams</span><span class="p">(</span><span class="n">unigrams</span><span class="p">))</span>

    <span class="c1"># Join the words in each bigram with an underscore</span>
    <span class="n">bigrams_formatted</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bigram</span><span class="p">)</span> <span class="k">for</span> <span class="n">bigram</span> <span class="ow">in</span> <span class="n">bigram_tuples</span><span class="p">]</span>

    <span class="c1"># Combine unigrams and bigrams into one list</span>
    <span class="n">combined_list</span> <span class="o">=</span> <span class="n">unigrams</span> <span class="o">+</span> <span class="n">bigrams_formatted</span>

    <span class="k">return</span> <span class="n">combined_list</span>


<span class="k">def</span> <span class="nf">generate_uni_bigrams_folder</span><span class="p">(</span><span class="n">source_folder</span><span class="p">,</span> <span class="n">destination_folder</span><span class="p">):</span>
    <span class="c1"># Create the destination folder if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">)</span>

    <span class="c1"># Iterate over each file in the source folder</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># Read the CSV file into a DataFrame</span>
            <span class="n">source_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">source_filepath</span><span class="p">)</span>

            <span class="c1"># Drop the &#39;Unnamed: 0&#39; column if it exists</span>
            <span class="k">if</span> <span class="s1">&#39;Unnamed: 0&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Apply the function generate_uni_bigrams to create &#39;uni_bigrams&#39; column</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;original_text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">generate_uni_bigrams_individual</span><span class="p">)</span>

            <span class="c1"># Define the new filename for the destination</span>
            <span class="n">csv_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_clean.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;_processed.csv&quot;</span><span class="p">)</span>
            <span class="n">destination_filepath_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">csv_filename</span><span class="p">)</span>

            <span class="n">json_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_clean.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;_processed.json&quot;</span><span class="p">)</span>
            <span class="n">destination_filepath_json</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">json_filename</span><span class="p">)</span>

            <span class="n">pkl_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_clean.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;_processed.pkl&quot;</span><span class="p">)</span>
            <span class="n">destination_filepath_pkl</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">pkl_filename</span><span class="p">)</span>

            <span class="c1"># Save the modified DataFrame to a new CSV file in the destination folder</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">destination_filepath_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">destination_filepath_json</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">destination_filepath_pkl</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed file &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39; successfully saved&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">count_total_occurrences</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
    <span class="c1"># Initialize a dictionary to store word counts</span>
    <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="p">:</span>  <span class="c1"># Convert to lowercase for case-insensitive matching</span>
            <span class="n">word_counts</span><span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Sum all the occurrences</span>
    <span class="n">total_occurrences</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">total_occurrences</span>


<span class="k">def</span> <span class="nf">count_individual_occurrences</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
    <span class="c1"># Initialize a dictionary to store counts of keywords, starting at 0</span>
    <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">}</span>

    <span class="c1"># Count occurrences of each keyword in the text</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">word_lower</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># Convert word to lowercase to ensure case-insensitive matching</span>
        <span class="k">if</span> <span class="n">word_lower</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="p">:</span>
            <span class="n">word_counts</span><span class="p">[</span><span class="n">word_lower</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Filter out keywords with zero occurrences</span>
    <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">count</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">word_counts</span>


<span class="k">def</span> <span class="nf">count_individual_score</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">keyword_weights</span><span class="p">):</span>
    <span class="c1"># Initialize a dictionary to store counts of keywords, starting at 0</span>
    <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">}</span>

    <span class="c1"># Count occurrences of each keyword in the text</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">word_lower</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># Convert word to lowercase to ensure case-insensitive matching</span>
        <span class="k">if</span> <span class="n">word_lower</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="p">:</span>
            <span class="n">word_counts</span><span class="p">[</span><span class="n">word_lower</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Filter out keywords with zero occurrences</span>
    <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">count</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">word_counts</span>


<span class="k">def</span> <span class="nf">calculate_keyword_scores</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">keyword_weights</span><span class="p">):</span>
    <span class="c1"># Initialize a dictionary to store counts of keywords</span>
    <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">}</span>

    <span class="c1"># Count occurrences of each keyword in the text</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">word_lower</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">word_lower</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="p">:</span>
            <span class="n">word_counts</span><span class="p">[</span><span class="n">word_lower</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Calculate scores for each keyword based on its weight and occurrence count</span>
    <span class="n">keyword_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">count</span> <span class="o">*</span> <span class="n">keyword_weights</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># Sort the keywords by their scores in descending order</span>
    <span class="n">sorted_keyword_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keyword_scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Convert the sorted list of tuples back into a dictionary</span>
    <span class="n">sorted_keyword_scores_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sorted_keyword_scores</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sorted_keyword_scores_dict</span>


<span class="k">def</span> <span class="nf">calculate_weighted_score</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">keyword_weights</span><span class="p">):</span>
    <span class="c1"># Initialize the total score</span>
    <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#print(text)</span>
    <span class="c1"># Split the text into words</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="c1"># If the word is in the list and has a weight, add its weighted score</span>
        <span class="c1"># Check if the word is in the keyword_weights dictionary and add its weighted score</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">keyword_weights</span><span class="p">:</span>
            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">keyword_weights</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total_score</span>


<span class="k">def</span> <span class="nf">extract_top_five_items</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
    <span class="c1"># Convert the string representation of dictionary to a dictionary object</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
    <span class="c1"># Sort the dictionary by values in descending order and take the first five items</span>
    <span class="n">top_five_items</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">top_five_items</span>


<span class="k">def</span> <span class="nf">extract_top_five_items</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
    <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>

    <span class="c1"># Convert sorted items back to a dictionary if needed</span>
    <span class="n">top_five_items</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sorted_items</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">top_five_items</span>


<span class="k">def</span> <span class="nf">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">classification</span><span class="p">(</span><span class="n">source_folder</span><span class="p">,</span> <span class="n">destination_folder</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">keyword_weights</span><span class="p">):</span>
    <span class="c1"># Create the destination folder if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">)</span>

    <span class="c1"># Iterate over each file in the source folder</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># Read the CSV file into a DataFrame</span>
            <span class="n">source_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="c1"># Drop the &#39;Unnamed: 0&#39; column if it exists</span>
                <span class="k">if</span> <span class="s1">&#39;Unnamed: 0&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Count occurrences of keywords in uni_bigrams</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams_occurrences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">count_total_occurrences</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">keywords</span><span class="p">))</span>

                <span class="c1"># Count occurrences of each keyword in the text</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams_word_counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">count_individual_occurrences</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">keywords</span><span class="p">))</span>

                <span class="c1"># top 5 keywords with scores</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;top5_uni_bigrams_word_counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams_word_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_top_five_items</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

                <span class="c1"># Calculate scores of each keyword in the text</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams_word_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">calculate_keyword_scores</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">keyword_weights</span><span class="p">))</span>

                <span class="c1"># Calculate total scores of keywords in the text</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_weighted_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">calculate_weighted_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">keyword_weights</span><span class="p">))</span>

                <span class="c1"># Count the words</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;original_text_word_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;original_text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">count_words</span><span class="p">)</span>

                <span class="c1"># Calculate total scores of keywords per word in the text</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_weighted_score_per_word&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;total_weighted_score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;original_text_word_count&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span>
                                                                                                     <span class="s1">&#39;original_text_word_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># top 5 keywords with scores</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;top5_uni_bigrams_word_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uni_bigrams_word_scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_top_five_items</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

                <span class="c1">#.apply(lambda x: extract_top_five_items(x) if isinstance(x, str) else {})</span>

                <span class="c1"># Define the new filename for the destination</span>
                <span class="n">csv_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_processed.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;_classified.csv&quot;</span><span class="p">)</span>
                <span class="n">destination_filepath_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">csv_filename</span><span class="p">)</span>

                <span class="n">json_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_processed.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;_classified.json&quot;</span><span class="p">)</span>
                <span class="n">destination_filepath_json</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">json_filename</span><span class="p">)</span>

                <span class="n">pkl_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_processed.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;_classified.pkl&quot;</span><span class="p">)</span>
                <span class="n">destination_filepath_pkl</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">pkl_filename</span><span class="p">)</span>

                <span class="c1"># Save the modified DataFrame to a new CSV file in the destination folder</span>
                <span class="c1">#df.to_csv(destination_filepath_csv, index=False)</span>
                <span class="c1">#df.to_json(destination_filepath_json, orient=&#39;records&#39;)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">destination_filepath_pkl</span><span class="p">)</span>

                <span class="c1"># This will hold the combined results</span>
                <span class="n">combined_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                <span class="c1"># Iterate through each dictionary in the DataFrame&#39;s column</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;uni_bigrams_word_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">combined_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>

                <span class="c1"># Convert the defaultdict back to a regular dictionary for display or further use</span>
                <span class="n">result_dict_count</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">combined_dict</span><span class="p">)</span>

                <span class="c1"># Create a WordCloud object</span>
                <span class="n">wordcloud</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

                <span class="c1"># Generate a word cloud from frequencies</span>
                <span class="n">wordcloud</span><span class="o">.</span><span class="n">generate_from_frequencies</span><span class="p">(</span><span class="n">result_dict_count</span><span class="p">)</span>

                <span class="c1"># Display the generated image:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wordcloud</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Do not show axes to keep it clean</span>

                <span class="n">pic_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_processed.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;_wordcloud_count.png&quot;</span><span class="p">)</span>
                <span class="n">destination_filepath_pic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">pic_filename</span><span class="p">)</span>

                <span class="c1"># Save the figure to a file</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">destination_filepath_pic</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

                <span class="n">dict_count_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_processed.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;_dic_count.csv&quot;</span><span class="p">)</span>
                <span class="n">destination_filepath_dict</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">dict_count_filename</span><span class="p">)</span>

                <span class="c1"># Convert dictionary to DataFrame</span>
                <span class="n">result_list_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result_dict_count</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Word&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">])</span>

                <span class="c1"># Save to CSV</span>
                <span class="n">result_list_count</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">destination_filepath_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># This will hold the combined results</span>
                <span class="n">combined_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                <span class="c1"># Iterate through each dictionary in the DataFrame&#39;s column</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;uni_bigrams_word_scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">combined_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>

                <span class="c1"># Convert the defaultdict back to a regular dictionary for display or further use</span>
                <span class="n">result_dict_score</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">combined_dict</span><span class="p">)</span>

                <span class="c1"># Create a WordCloud object</span>
                <span class="n">wordcloud</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

                <span class="c1"># Generate a word cloud from frequencies</span>
                <span class="n">wordcloud</span><span class="o">.</span><span class="n">generate_from_frequencies</span><span class="p">(</span><span class="n">result_dict_score</span><span class="p">)</span>

                <span class="c1"># Display the generated image:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wordcloud</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Do not show axes to keep it clean</span>

                <span class="n">pic_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_processed.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;_wordcloud_score.png&quot;</span><span class="p">)</span>
                <span class="n">destination_filepath_pic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">pic_filename</span><span class="p">)</span>

                <span class="c1"># Save the figure to a file</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">destination_filepath_pic</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

                <span class="n">dict_count_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_processed.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;_dic_score.csv&quot;</span><span class="p">)</span>
                <span class="n">destination_filepath_dict</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">dict_count_filename</span><span class="p">)</span>

                <span class="c1"># Convert dictionary to DataFrame</span>
                <span class="n">result_list_score</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result_dict_score</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Word&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">])</span>

                <span class="c1"># Save to CSV</span>
                <span class="n">result_list_score</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">destination_filepath_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classified file &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39; successfully saved&quot;</span><span class="p">)</span>


<span class="n">source_folder</span> <span class="o">=</span> <span class="s2">&quot;./Raw_Data/Cleaned&quot;</span>
<span class="n">destination_folder</span> <span class="o">=</span> <span class="s2">&quot;./Processed_Data&quot;</span>

<span class="n">generate_uni_bigrams_folder</span><span class="p">(</span><span class="n">source_folder</span><span class="p">,</span> <span class="n">destination_folder</span><span class="p">)</span>

<span class="n">keywords</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;./Meachine Learning/gtm/agriculture_1000_0.1_human_refinement.xlsx&#39;</span><span class="p">)[</span>
    <span class="s1">&#39;keyword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">keyword_weights</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;./Meachine Learning/gtm/agriculture_1000_0.1_human_refinement.xlsx&#39;</span><span class="p">)[</span><span class="s1">&#39;keyword&#39;</span><span class="p">],</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;./Meachine Learning/gtm/agriculture_1000_0.1_human_refinement.xlsx&#39;</span><span class="p">)[</span><span class="s1">&#39;weight&#39;</span><span class="p">]))</span>
<span class="n">source_folder</span> <span class="o">=</span> <span class="s2">&quot;./Processed_Data&quot;</span>
<span class="n">destination_folder</span> <span class="o">=</span> <span class="s2">&quot;./Outcomes&quot;</span>

<span class="n">classification</span><span class="p">(</span><span class="n">source_folder</span><span class="p">,</span> <span class="n">destination_folder</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">keyword_weights</span><span class="p">)</span>
<span class="c1">########</span>
<span class="n">destination_folder</span> <span class="o">=</span> <span class="s2">&quot;./Outcomes&quot;</span>

<span class="c1"># Define the columns to keep</span>
<span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;act_num&#39;</span><span class="p">,</span> <span class="s1">&#39;uni_bigrams_occurrences&#39;</span><span class="p">,</span> <span class="s1">&#39;uni_bigrams_word_counts&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;top5_uni_bigrams_word_counts&#39;</span><span class="p">,</span> <span class="s1">&#39;uni_bigrams_word_scores&#39;</span><span class="p">,</span> <span class="s1">&#39;total_weighted_score&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;original_text_word_count&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;total_weighted_score_per_word&#39;</span><span class="p">,</span> <span class="s1">&#39;top5_uni_bigrams_word_scores&#39;</span><span class="p">]</span>

<span class="c1"># Initialize an empty DataFrame to hold all the data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="c1"># Loop through each file in the folder</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;count.csv&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">):</span>  <span class="c1"># Check if the file is a CSV</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="c1">#with open(file_path, &#39;rb&#39;) as file:</span>
        <span class="c1">#data = pickle.load(file)</span>
        <span class="c1">#data = data[columns_to_keep]</span>
        <span class="c1"># Append the data to the main DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">_append</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#df[&#39;top5_uni_bigrams_word_scores&#39;] = df[&#39;uni_bigrams_word_scores&#39;].apply(lambda d: {k: d[k] for k in list(d.keys())[:5]} if isinstance(d, dict) else d)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Word&#39;</span><span class="p">)[</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./Outcomes/all_words_count.csv&#39;</span><span class="p">)</span>

<span class="c1"># Convert DataFrame to dictionary</span>
<span class="n">word_freq</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Word&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]))</span>

<span class="c1"># Create a WordCloud object</span>
<span class="n">wordcloud</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

<span class="c1"># Generate a word cloud</span>
<span class="n">wordcloud</span><span class="o">.</span><span class="n">generate_from_frequencies</span><span class="p">(</span><span class="n">word_freq</span><span class="p">)</span>

<span class="c1"># Display the generated image:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wordcloud</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Do not show axes to keep it clean</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./Outcomes/counts.png&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># Initialize an empty DataFrame to hold all the data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="c1"># Loop through each file in the folder</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;score.csv&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">):</span>  <span class="c1"># Check if the file is a CSV</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="c1">#with open(file_path, &#39;rb&#39;) as file:</span>
        <span class="c1">#data = pickle.load(file)</span>
        <span class="c1">#data = data[columns_to_keep]</span>
        <span class="c1"># Append the data to the main DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">_append</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#df[&#39;top5_uni_bigrams_word_scores&#39;] = df[&#39;uni_bigrams_word_scores&#39;].apply(lambda d: {k: d[k] for k in list(d.keys())[:5]} if isinstance(d, dict) else d)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Word&#39;</span><span class="p">)[</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./Outcomes/all_words_score.csv&#39;</span><span class="p">)</span>

<span class="c1"># Convert DataFrame to dictionary</span>
<span class="n">word_freq</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Word&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]))</span>

<span class="c1"># Create a WordCloud object</span>
<span class="n">wordcloud</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

<span class="c1"># Generate a word cloud</span>
<span class="n">wordcloud</span><span class="o">.</span><span class="n">generate_from_frequencies</span><span class="p">(</span><span class="n">word_freq</span><span class="p">)</span>

<span class="c1"># Display the generated image:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wordcloud</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Do not show axes to keep it clean</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./Outcomes/scores.png&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./Outcomes/classification_results.csv&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1975</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2021</span><span class="p">)]</span>

<span class="c1"># Group by &#39;year&#39; and &#39;state&#39; and calculate the count of positive scores and the total count of scores</span>
<span class="n">grouped_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">positive_score_count</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;total_weighted_score_per_word&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
    <span class="n">total_score_count</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;total_weighted_score_per_word&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Calculate the proportion of the count of positive scores to the total count of scores</span>
<span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;proportion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;positive_score_count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;total_score_count&#39;</span><span class="p">]</span>

<span class="c1"># Reset the index to make &#39;year&#39; and &#39;state&#39; columns again</span>
<span class="n">grouped_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">grouped_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./Outcomes/classification_results_short.csv&#39;</span><span class="p">)</span>

<span class="c1"># Pivot the data for plotting</span>
<span class="n">pivot_data</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;proportion&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>  <span class="c1"># Increase figure size for better clarity and space</span>
<span class="n">pivot_data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>

<span class="c1"># Increase font sizes for better readability</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Proportion of Ag Legislation per Year by State&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Proportion of Ag Legislation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Increase tick label size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Expand the right margin to ensure the legend and plot do not overlap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.65</span><span class="p">)</span>

<span class="c1"># Place the legend to the right of the plot, making it larger to ensure legibility</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Add grid for better readability of the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">state_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">ag_count</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;total_weighted_score_per_word&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
    <span class="n">ag_count_0004</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;total_weighted_score_per_word&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.004</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
    <span class="n">total_count</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;total_weighted_score_per_word&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">state_data</span><span class="p">[</span><span class="s1">&#39;ag_proportion_0000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_data</span><span class="p">[</span><span class="s1">&#39;ag_count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">state_data</span><span class="p">[</span><span class="s1">&#39;total_count&#39;</span><span class="p">]</span>
<span class="n">state_data</span><span class="p">[</span><span class="s1">&#39;ag_proportion_0004&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_data</span><span class="p">[</span><span class="s1">&#39;ag_count_0004&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">state_data</span><span class="p">[</span><span class="s1">&#39;total_count&#39;</span><span class="p">]</span>
<span class="n">state_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./Outcomes/state.csv&#39;</span><span class="p">)</span>

<span class="n">state_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./Outcomes/state.csv&#39;</span><span class="p">)</span>

<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;./Geo/cb_2018_us_state_500k.shp&#39;</span><span class="p">)</span>

<span class="n">fips</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;./Geo/statefp.xlsx&#39;</span><span class="p">)</span>
<span class="n">fips</span><span class="p">[</span><span class="s1">&#39;STATEFP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fips</span><span class="p">[</span><span class="s1">&#39;STATEFP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fips</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;STATEFP&#39;</span><span class="p">)</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">state_data</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;state&#39;</span><span class="p">)</span>


<span class="c1"># Apply this to the gdf to ensure all states are assigned colors by the same func</span>
<span class="k">def</span> <span class="nf">makeColorColumn</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">):</span>
    <span class="c1"># apply a function to a column to create a new column of assigned colors &amp; return full frame</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">YlOrBr</span><span class="p">)</span>
    <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;value_determined_color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">gdf</span>


<span class="c1"># set the value column that will be visualised</span>
<span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;ag_proportion_0000&#39;</span>
<span class="c1">#variable = &#39;ag_proportion_0004&#39;</span>

<span class="c1"># make a column for value_determined_color in gdf</span>
<span class="c1"># set the range for the choropleth values with the upper bound the rounded up maximum value</span>

<span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;ag_proportion_0000&#39;</span><span class="p">:</span>
    <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;ag_proportion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;ag_proportion_0000&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;ag_proportion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;ag_proportion_0004&#39;</span><span class="p">]</span>

<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">ag_proportion</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">gdf</span><span class="o">.</span><span class="n">ag_proportion</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># Choose the continuous colorscale &quot;YlOrBr&quot; from https://matplotlib.org/stable/tutorials/colors/colormaps.html</span>
<span class="n">colormap</span> <span class="o">=</span> <span class="s2">&quot;YlOrBr&quot;</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">makeColorColumn</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>

<span class="c1"># create &quot;visframe&quot; as a re-projected gdf using EPSG 2163 for CONUS</span>
<span class="c1">#visframe = gdf.to_crs({&#39;init&#39;:&#39;epsg:2163&#39;})</span>
<span class="n">visframe</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">({</span><span class="s1">&#39;proj&#39;</span><span class="p">:</span> <span class="s1">&#39;aea&#39;</span><span class="p">,</span> <span class="s1">&#39;lat_1&#39;</span><span class="p">:</span> <span class="mf">29.5</span><span class="p">,</span> <span class="s1">&#39;lat_2&#39;</span><span class="p">:</span> <span class="mf">45.5</span><span class="p">,</span> <span class="s1">&#39;lon_0&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">96</span><span class="p">,</span> <span class="s1">&#39;lat_0&#39;</span><span class="p">:</span> <span class="mf">37.5</span><span class="p">})</span>

<span class="c1"># create figure and axes for Matplotlib</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="c1"># remove the axis box around the vis</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="c1"># set the font for the visualization to Helvetica</span>
<span class="n">hfont</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontname&#39;</span><span class="p">:</span> <span class="s1">&#39;Helvetica&#39;</span><span class="p">}</span>

<span class="c1"># add a title and annotation</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;State-Level Agricultural Legislation</span><span class="se">\n</span><span class="s1">1975-2021&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">hfont</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;12&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">})</span>

<span class="c1"># Create colorbar legend</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="c1"># add colorbar axes to the figure</span>
<span class="c1"># This will take some iterating to get it where you want it [l,b,w,h] right</span>
<span class="c1"># l:left, b:bottom, w:width, h:height; in normalized unit (0-1)</span>
<span class="n">cbax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.89</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.31</span><span class="p">])</span>

<span class="n">cbax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Percentage </span><span class="se">\n</span><span class="s1"> of Ag Legislation </span><span class="se">\n</span><span class="s1"> (1975-2021)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">hfont</span><span class="p">,</span>
               <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;12&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">})</span>

<span class="c1"># add color scale</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span> \
                           <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">))</span>
<span class="c1"># reformat tick labels on legend</span>
<span class="n">sm</span><span class="o">.</span><span class="n">_A</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#comma_fmt = FuncFormatter(lambda x, p: format(x/100, &#39;%&#39;))</span>
<span class="n">comma_fmt</span> <span class="o">=</span> <span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbax</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">comma_fmt</span><span class="p">)</span>
<span class="n">tick_font_size</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">cbax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">tick_font_size</span><span class="p">)</span>
<span class="c1"># annotate the data source, date of access, and hyperlink</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;Data: Authors&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">.085</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;figure fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#555555&#39;</span><span class="p">)</span>

<span class="c1"># create map</span>
<span class="c1"># Note: we&#39;re going state by state here because of unusual coloring behavior when trying to plot the entire dataframe using the &quot;value_determined_color&quot; column</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">visframe</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AK&#39;</span><span class="p">,</span> <span class="s1">&#39;HI&#39;</span><span class="p">]:</span>  <span class="c1"># Exclude Alaska and Hawaii for this part</span>
        <span class="n">vf</span> <span class="o">=</span> <span class="n">visframe</span><span class="p">[</span><span class="n">visframe</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">state</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ag_proportion</span><span class="p">):</span>  <span class="c1"># Check if the ag_proportion is NaN</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;lightgrey&#39;</span>  <span class="c1"># Set color to grey for missing data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;value_determined_color&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span>

<span class="c1"># add Alaska</span>
<span class="n">akax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">])</span>
<span class="n">akax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="c1"># polygon to clip western islands</span>
<span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="o">-</span><span class="mi">170</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">170</span><span class="p">,</span> <span class="mi">72</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span> <span class="mi">72</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span> <span class="mi">50</span><span class="p">)])</span>
<span class="n">alaska_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;AK&#39;</span><span class="p">]</span>
<span class="n">alaska_gdf</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;AK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_determined_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">akax</span><span class="p">,</span>
                              <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span>

<span class="c1"># add Hawaii</span>
<span class="n">hiax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">.58</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
<span class="n">hiax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="err">`</span>
<span class="c1"># polygon to clip western islands</span>
<span class="n">hipolygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="o">-</span><span class="mi">160</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">160</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
<span class="n">hawaii_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;HI&#39;</span><span class="p">]</span>

<span class="c1"># Clip the Hawaii GeoDataFrame to the desired area</span>
<span class="n">clipped_hawaii_gdf</span> <span class="o">=</span> <span class="n">hawaii_gdf</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">hipolygon</span><span class="p">)</span>

<span class="c1"># Plot the clipped Hawaii GeoDataFrame using the &#39;value_determined_color&#39; column for color</span>
<span class="c1">#color = hawaii_gdf[&#39;value_determined_color&#39;].iloc[0] if not hawaii_gdf.empty else &#39;lightgrey&#39;</span>
<span class="n">clipped_hawaii_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">hiax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;ag_proportion_0000&#39;</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;./Outcomes/ag_legislation_1975_2021_0000.png&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;./Outcomes/ag_legislation_1975_2021_0004.png&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

<span class="c1"># bbox_inches=&quot;tight&quot; keeps the vis from getting cut off at the edges in the saved png</span>
<span class="c1"># dip is &quot;dots per inch&quot; and controls image quality.  Many scientific journals have specifications for this</span>
<span class="c1"># https://stackoverflow.com/questions/16183462/saving-images-in-python-at-a-very-high-quality</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-ch5"></span><section class="tex2jax_ignore mathjax_ignore" id="chapter-5-sentiment-analysis">
<h2>Chapter 5 Sentiment analysis<a class="headerlink" href="#chapter-5-sentiment-analysis" title="Link to this heading">#</a></h2>
<p>sentiment analysis</p>
</section>
<span id="document-ch6"></span><section class="tex2jax_ignore mathjax_ignore" id="chapter-6-conclusion">
<h2>Chapter 6 Conclusion<a class="headerlink" href="#chapter-6-conclusion" title="Link to this heading">#</a></h2>
</section>
<span id="document-ch7"></span><section class="tex2jax_ignore mathjax_ignore" id="chapter-7-appendix">
<h2>Chapter 7 Appendix<a class="headerlink" href="#chapter-7-appendix" title="Link to this heading">#</a></h2>
</section>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-Cover">Codebook for State-Level Policies Affecting Agricultural Costs and Revenues in the U.S.: a comprehensive database (1975-2021), patterns, and analysis of policy correlates</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch1">Chapter 1 Introduction</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch2">Chapter 2 Web-scraping tool setup</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch3">Chapter 3 Data cleaning</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch4">Chapter 4 Topic Classification</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="intro.html#topic-classification">4.2 Topic Classification</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch5">Chapter 5 Sentiment analysis</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch6">Chapter 6 Conclusion</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-ch7">Chapter 7 Appendix</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By UMN UCSC AFRI Project
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>